<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Blog of WangZhixiong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="This is a place where i want to share">
<meta property="og:type" content="website">
<meta property="og:title" content="Blog of WangZhixiong">
<meta property="og:url" content="https://yunshucloud.github.io/blog/index.html">
<meta property="og:site_name" content="Blog of WangZhixiong">
<meta property="og:description" content="This is a place where i want to share">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="WangZhixiong">
<meta property="article:tag" content="JAVA">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="Blog of WangZhixiong" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Blog of WangZhixiong</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">Become Better</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/blog/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://yunshucloud.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-IocContainer" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/10/20/IocContainer/" class="article-date">
  <time class="dt-published" datetime="2023-10-20T07:24:51.000Z" itemprop="datePublished">2023-10-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/10/20/IocContainer/">IocContainer</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、Spring-Ioc容器和Beans的介绍-Introduction-to-the-Spring-Ioc-Container-and-Beans"><a href="#一、Spring-Ioc容器和Beans的介绍-Introduction-to-the-Spring-Ioc-Container-and-Beans" class="headerlink" title="一、Spring Ioc容器和Beans的介绍(Introduction to the Spring Ioc Container and Beans)"></a>一、Spring Ioc容器和Beans的介绍(Introduction to the Spring Ioc Container and Beans)</h1><h2 id="1-Ioc"><a href="#1-Ioc" class="headerlink" title="1.Ioc"></a>1.Ioc</h2><p>Ioc(控制反转)也被称为DI(依赖注入)。<br>它是一个过程，此过程定义了对象之间的依赖关系，即一个对象中需要另一个对象协作的关系。<br>此关系是通过构造参数，工厂参数或者对象实例中被set的属性建立的。<br>此过程要在对象实例化之后或者对象由工厂返回之后进行，即对象要先被创建在能定义他们的依赖关系。</p>
<img src="/blog/2023/10/20/IocContainer/Ioc.png" class>

<h2 id="2-BeanFactory-和-ApplicationContext"><a href="#2-BeanFactory-和-ApplicationContext" class="headerlink" title="2. BeanFactory 和 ApplicationContext"></a>2. BeanFactory 和 ApplicationContext</h2><p><strong>org.springframework.beans</strong> 和 <strong>org.springframework.context</strong> 两个包是Ioc容器的基础。<br>通过在<a target="_blank" rel="noopener" href="https://mvnrepository.com/">https://mvnrepository.com</a> 网址搜索上文的两个包</p>
<ol>
<li>打开网址<img src="/blog/2023/10/20/IocContainer/mvnRepo.png" class></li>
<li>选择版本<img src="/blog/2023/10/20/IocContainer/mvnRepoV.png" class></li>
<li>复制依赖<img src="/blog/2023/10/20/IocContainer/mvnRepoM.png" class></li>
<li>项目工程依赖<img src="/blog/2023/10/20/IocContainer/mvnIoc.png" class></li>
</ol>
<p>BeanFacotry接口提供了管理任何对象类型的配置机制<br>ApplicationContext是BeanFactory的子接口。它增加了：</p>
<ul>
<li>更便捷的Spring Aop特征的整合</li>
<li>消息资源的处理(在国际化的使用中)</li>
<li>事务发布</li>
<li>应用层的特殊上下文context，例如WebApplicationContext，是为使用web应用设计的</li>
</ul>
<ol>
<li>BeanFactory<img src="/blog/2023/10/20/IocContainer/BeanFactory.png" class></li>
<li>ApplicationContext<img src="/blog/2023/10/20/IocContainer/ApplicationContext.png" class></li>
</ol>
<h3 id="3-Beans"><a href="#3-Beans" class="headerlink" title="3. Beans"></a>3. Beans</h3><p>在Spring中,构成应用骨架的对象或者被Spring Ioc容器管理的对象称为beans.</p>
<h1 id="二、容器简介（Container-Overview）"><a href="#二、容器简介（Container-Overview）" class="headerlink" title="二、容器简介（Container Overview）"></a>二、容器简介（Container Overview）</h1><p>org.springframework.context.ApplicationContext 接口代表了Spring Ioc容器，并且负责实例化beans,配置bean,集成(assemble)。容器通过读取配置元数据(configuration metedata)来获取一些指令，这些指令主要是指明需要实例化哪个对象，配置哪个对象以及集成（assemble）哪个对象。配置元数据（configuration metedata）的形式有三种，第一，xml文件形式，第二，java注解形式，第三，java代码形式。配置元数据（configurateion metedata）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunshucloud.github.io/blog/2023/10/20/IocContainer/" data-id="clnyod4w600009xk6ey7kg9ay" data-title="IocContainer" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hasCodeAndEquals" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/10/18/hasCodeAndEquals/" class="article-date">
  <time class="dt-published" datetime="2023-10-18T05:54:32.000Z" itemprop="datePublished">2023-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/10/18/hasCodeAndEquals/">hasCodeAndEquals</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="equals方法和hasCode方法之间的关系"><a href="#equals方法和hasCode方法之间的关系" class="headerlink" title="equals方法和hasCode方法之间的关系"></a>equals方法和hasCode方法之间的关系</h1><h3 id="equals方法"><a href="#equals方法" class="headerlink" title="equals方法"></a>equals方法</h3><img src="/blog/2023/10/18/hasCodeAndEquals/equals.png" class>

<h3 id="hasCode方法"><a href="#hasCode方法" class="headerlink" title="hasCode方法"></a>hasCode方法</h3><img src="/blog/2023/10/18/hasCodeAndEquals/hasCode.png" class>

<ul>
<li>A. <ul>
<li>只要equals方法没有被重写，同一个对象的hasCode值就不会有变化</li>
<li>同一个对象，hasCode值不保证在不同执行情况下结果相同</li>
</ul>
</li>
<li>B. <ul>
<li>只要equals方法判断两个对象相同，他们的hasCode值必然相同</li>
</ul>
</li>
<li>C.<ul>
<li>两个对象不相同时，不保证他们的hasCode值一定不同</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunshucloud.github.io/blog/2023/10/18/hasCodeAndEquals/" data-id="clnyod4w800019xk6d53z434y" data-title="hasCodeAndEquals" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-rabbitmq" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/09/22/rabbitmq/" class="article-date">
  <time class="dt-published" datetime="2023-09-22T13:45:17.000Z" itemprop="datePublished">2023-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/09/22/rabbitmq/">rabbitmq</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、Docker安装Rabbitmq"><a href="#一、Docker安装Rabbitmq" class="headerlink" title="一、Docker安装Rabbitmq"></a>一、Docker安装Rabbitmq</h1><ol>
<li><p>使用docker下载rabbitmq镜像</p>
<img src="/blog/2023/09/22/rabbitmq/rabbitmqdocker.png" class>
</li>
<li><p>启动rabbitmq服务</p>
<blockquote>
<p>docker run -d –hostname yunshuhostname –name rabbit -p 15672:15672 -p 5672:5672 rabbitmq</p>
</blockquote>
<img src="/blog/2023/09/22/rabbitmq/rabbitmqrun.png" class>
</li>
<li><p>进入容器，开启管控台</p>
<img src="/blog/2023/09/22/rabbitmq/start.png" class>
</li>
<li><p>打开浏览器,通过管控台访问rabbitmq 用户:guest 密码:guest</p>
<img src="/blog/2023/09/22/rabbitmq/test.png" class></li>
</ol>
<h1 id="二、使用rabbitmq"><a href="#二、使用rabbitmq" class="headerlink" title="二、使用rabbitmq"></a>二、使用rabbitmq</h1><h2 id="2-1-项目工程中引入rabbitmq依赖"><a href="#2-1-项目工程中引入rabbitmq依赖" class="headerlink" title="2.1 项目工程中引入rabbitmq依赖"></a>2.1 项目工程中引入rabbitmq依赖</h2><img src="/blog/2023/09/22/rabbitmq/rabbitDep.png" class>

<h2 id="2-2rabbitmq的六种模式"><a href="#2-2rabbitmq的六种模式" class="headerlink" title="2.2rabbitmq的六种模式"></a>2.2rabbitmq的六种模式</h2><p>RabbitMQ共有六种工作模式：</p>
<ol>
<li>简单模式（Simple）</li>
<li>工作队列模式（Work Queue）</li>
<li>发布订阅模式（Publish&#x2F;Subscribe）</li>
<li>路由模式（Routing）</li>
<li>通配符模式（Topics）</li>
<li>远程调用模式（RPC，不常用）</li>
</ol>
<h2 id="2-3-简单模式（Simple）"><a href="#2-3-简单模式（Simple）" class="headerlink" title="2.3 简单模式（Simple）"></a>2.3 简单模式（Simple）</h2><ul>
<li>特点：一个生产者对应一个消费者，通过队列进行消息传递。<br>该模式使用direct交换机，direct交换机是RabbitMQ默认交换机。<img src="/blog/2023/09/22/rabbitmq/simple.png" class></li>
</ul>
<ol>
<li><p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.创建队列，如果队列已存在，则使用该队列</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：队列名</span></span><br><span class="line"><span class="comment">         * 参数2：是否持久化，true表示MQ重启后队列还在。</span></span><br><span class="line"><span class="comment">         * 参数3：是否私有化，false表示所有消费者都可以访问，true表示只有第一次拥有它的消费者才能访问</span></span><br><span class="line"><span class="comment">         * 参数4：是否自动删除，true表示不再使用队列时自动删除队列</span></span><br><span class="line"><span class="comment">         * 参数5：其他额外参数</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 5.发送消息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;hello!rabbitmq!&quot;</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：交换机名，&quot;&quot;表示默认交换机</span></span><br><span class="line"><span class="comment">         * 参数2：路由键，简单模式就是队列名</span></span><br><span class="line"><span class="comment">         * 参数3：其他额外参数</span></span><br><span class="line"><span class="comment">         * 参数4：要传递的消息字节数组</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">null</span>,message.getBytes());</span><br><span class="line">        <span class="comment">// 6.关闭信道和连接</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;===发送成功===&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：监听的队列名</span></span><br><span class="line"><span class="comment">         * 参数2：是否自动签收，如果设置为false，则需要手动确认消息已收到，否则MQ会一直发送消息</span></span><br><span class="line"><span class="comment">         * 参数3：Consumer的实现类，重写该类方法表示接受到消息后如何消费</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;simple_queue&quot;</span>,<span class="literal">true</span>,<span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;接受消息，消息为：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>效果</p>
<img src="/blog/2023/09/22/rabbitmq/simpleres.png" class></li>
</ol>
<h2 id="2-4-工作队列模式（Work-Queue）"><a href="#2-4-工作队列模式（Work-Queue）" class="headerlink" title="2.4 工作队列模式（Work Queue）"></a>2.4 工作队列模式（Work Queue）</h2><ul>
<li>与简单模式相比，工作队列模式(Work Queue)多了一些消费者，该模式也使用direct交换机，应用于处理消息较多的情况。特点如下：<ul>
<li>一个队列对应多个消费者。</li>
<li>一条消息只会被一个消费者消费。</li>
<li>消息队列默认采用轮询的方式将消息平均发送给消费者。<img src="/blog/2023/09/22/rabbitmq/workque.png" class></li>
</ul>
</li>
</ul>
<ol>
<li><p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.创建队列，持久化队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;work_queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 5.发送大量消息，参数3表示该消息为持久化消息，即除了保存到内存还会保存到磁盘中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>,<span class="string">&quot;work_queue&quot;</span>, MessageProperties.PERSISTENT_TEXT_PLAIN,</span><br><span class="line">                    (<span class="string">&quot;你好，这是今天的第&quot;</span>+i+<span class="string">&quot;条消息&quot;</span>).getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6.关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>消费者（3个 类似）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列，处理消息</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;work_queue&quot;</span>,<span class="literal">true</span>,<span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;消费者1消费消息，消息为：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>效果</p>
<img src="/blog/2023/09/22/rabbitmq/cus1.png" class>
<img src="/blog/2023/09/22/rabbitmq/cus2.png" class>
<img src="/blog/2023/09/22/rabbitmq/cus3.png" class></li>
</ol>
<h2 id="2-4-发布订阅模式-Publish-Subscribe"><a href="#2-4-发布订阅模式-Publish-Subscribe" class="headerlink" title="2.4 发布订阅模式(Publish&#x2F;Subscribe)"></a>2.4 发布订阅模式(Publish&#x2F;Subscribe)</h2><ul>
<li>特点：生产者将消息发送给交换机，交换机将消息转发到绑定此交换机的每个队列中。<br>工作队列模式的交换机只能将消息发送给一个队列，发布订阅模式的交换机能将消息发送给多个队列。发布订阅模式使用fanout交换机。<img src="/blog/2023/09/22/rabbitmq/publish.png" class></li>
</ul>
<ol>
<li>生产者<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.创建交换机</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：交换机名</span></span><br><span class="line"><span class="comment">         * 参数2：交换机类型</span></span><br><span class="line"><span class="comment">         * 参数3：交换机持久化</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;exchange_fanout&quot;</span>, BuiltinExchangeType.FANOUT,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 5.创建队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_MAIL&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_MESSAGE&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_STATION&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 6.交换机绑定队列</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 参数1：队列名</span></span><br><span class="line"><span class="comment">         * 参数2：交换机名</span></span><br><span class="line"><span class="comment">         * 参数3：路由关键字，发布订阅模式写&quot;&quot;即可</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_MAIL&quot;</span>,<span class="string">&quot;exchange_fanout&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_MESSAGE&quot;</span>,<span class="string">&quot;exchange_fanout&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_STATION&quot;</span>,<span class="string">&quot;exchange_fanout&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 7.发送消息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">10</span> ; i++) &#123;</span><br><span class="line">            channel.basicPublish(<span class="string">&quot;exchange_fanout&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="literal">null</span>,</span><br><span class="line">                    (<span class="string">&quot;你好，尊敬的用户，秒杀商品开抢了！&quot;</span>+i).getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 8.关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
生产者后启动后</li>
</ol>
<ul>
<li>新增交换机exchange_fanout<img src="/blog/2023/09/22/rabbitmq/ex.png" class></li>
<li>新增queue<img src="/blog/2023/09/22/rabbitmq/qu.png" class></li>
</ul>
<ol start="2">
<li><p>message消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerMessage</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_MESSAGE&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送短信：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>mail消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerMail</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_MAIL&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送邮件：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>station消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomerStation</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_STATION&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送站内信：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>效果</p>
<img src="/blog/2023/09/22/rabbitmq/message.png" class>
<img src="/blog/2023/09/22/rabbitmq/mail.png" class>
<img src="/blog/2023/09/22/rabbitmq/station.png" class></li>
</ol>
<h2 id="2-5-路由模式（Routing）"><a href="#2-5-路由模式（Routing）" class="headerlink" title="2.5 路由模式（Routing）"></a>2.5 路由模式（Routing）</h2><ul>
<li>使用发布订阅模式时，所有消息都会发送到绑定的队列中，但很多时候，不是所有消息都无差别的发布到所有队列中。比如电商网站的促销活动，双十一大促可能会发布到所有队列；而一些小的促销活动为了节约成本，只发布到站内信队列。此时需要使用路由模式(Routing)完成这一需求。</li>
</ul>
<ul>
<li>特点：<ul>
<li>每个队列绑定路由关键字RoutingKey</li>
<li>生产者将带有RoutingKey的消息发送给交换机，交换机根+ 据RoutingKey转发到指定队列。路由模式使用direct交换机。  <img src="/blog/2023/09/22/rabbitmq/router.png" class></li>
</ul>
</li>
</ul>
<ol>
<li><p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.创建交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;exchange_routing&quot;</span>, BuiltinExchangeType.DIRECT,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 5.创建队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_MAIL2&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_MESSAGE2&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_STATION2&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 6.交换机绑定队列</span></span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_MAIL2&quot;</span>,<span class="string">&quot;exchange_routing&quot;</span>,<span class="string">&quot;import&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_MESSAGE2&quot;</span>,<span class="string">&quot;exchange_routing&quot;</span>,<span class="string">&quot;import&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_STATION2&quot;</span>,<span class="string">&quot;exchange_routing&quot;</span>,<span class="string">&quot;import&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_STATION2&quot;</span>,<span class="string">&quot;exchange_routing&quot;</span>,<span class="string">&quot;normal&quot;</span>);</span><br><span class="line">        <span class="comment">// 7.发送消息</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;exchange_routing&quot;</span>,<span class="string">&quot;import&quot;</span>,<span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;双十一大促活动&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;exchange_routing&quot;</span>,<span class="string">&quot;normal&quot;</span>,<span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;小心促销活动&quot;</span>.getBytes());</span><br><span class="line">        <span class="comment">// 8.关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>mail消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer_Mail</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_MAIL2&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送邮件：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>message消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer_Message</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);<span class="comment">// 默认虚拟机</span></span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_MESSAGE2&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送短信：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>station消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Customer_Station</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);<span class="comment">// 默认虚拟机</span></span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_STATION2&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送站内信：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>效果</p>
<img src="/blog/2023/09/22/rabbitmq/mailrouter.png" class>
<img src="/blog/2023/09/22/rabbitmq/messagerouter.png" class>
<img src="/blog/2023/09/22/rabbitmq/stationrouter.png" class></li>
</ol>
<h2 id="2-6-通配符模式（Topics）"><a href="#2-6-通配符模式（Topics）" class="headerlink" title="2.6 通配符模式（Topics）"></a>2.6 通配符模式（Topics）</h2><ul>
<li><p>通配符模式(Topic)是在路由模式的基础上，给队列绑定带通配符的路由关键字，只要消息的RoutingKey能实现通配符匹配，就会将消息转发到该队列。通配符模式比路由模式更灵活，使用topic交换机。</p>
</li>
<li><p>通配符规则：</p>
<ul>
<li>消息设置RoutingKey时，RoutingKey由多个单词构成，中间以.分割。</li>
<li>队列设置RoutingKey时，#可以匹配任意多个单词，*可以匹配任意一个单词。</li>
</ul>
  <img src="/blog/2023/09/22/rabbitmq/topics.png" class></li>
</ul>
<ol>
<li><p>生产者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line">        <span class="comment">// 3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">        <span class="comment">// 4.创建交换机</span></span><br><span class="line">        channel.exchangeDeclare(<span class="string">&quot;exchange_topic&quot;</span>, BuiltinExchangeType.TOPIC,<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 5.创建队列</span></span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_MAIL3&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_MESSAGE3&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        channel.queueDeclare(<span class="string">&quot;SEND_STATION3&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 6.交换机绑定队列</span></span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_MAIL3&quot;</span>,<span class="string">&quot;exchange_topic&quot;</span>,<span class="string">&quot;#.mail.#&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_MESSAGE3&quot;</span>,<span class="string">&quot;exchange_topic&quot;</span>,<span class="string">&quot;#.message.#&quot;</span>);</span><br><span class="line">        channel.queueBind(<span class="string">&quot;SEND_STATION3&quot;</span>,<span class="string">&quot;exchange_topic&quot;</span>,<span class="string">&quot;#.station.#&quot;</span>);</span><br><span class="line">        <span class="comment">// 7.发送消息</span></span><br><span class="line">        channel.basicPublish(<span class="string">&quot;exchange_topic&quot;</span>,<span class="string">&quot;mail.message.station&quot;</span>,<span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;双十一大促活动&quot;</span>.getBytes());</span><br><span class="line">        channel.basicPublish(<span class="string">&quot;exchange_topic&quot;</span>,<span class="string">&quot;station&quot;</span>,<span class="literal">null</span>,</span><br><span class="line">                <span class="string">&quot;小型促销活动&quot;</span>.getBytes());</span><br><span class="line">        <span class="comment">// 8.关闭资源</span></span><br><span class="line">        channel.close();</span><br><span class="line">        connection.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>station消费者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer_Station</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 1.创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;121.43.236.238&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;guest&quot;</span>);;</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);<span class="comment">// 默认虚拟机</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.创建连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> connectionFactory.newConnection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.建立信道</span></span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> conn.createChannel();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.监听队列</span></span><br><span class="line">        channel.basicConsume(<span class="string">&quot;SEND_STATION3&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(body, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">                System.out.println(<span class="string">&quot;发送站内信：&quot;</span>+message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunshucloud.github.io/blog/2023/09/22/rabbitmq/" data-id="clnyod4wa00049xk6e6p64bmo" data-title="rabbitmq" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-mysqlOptimize" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/09/17/mysqlOptimize/" class="article-date">
  <time class="dt-published" datetime="2023-09-17T09:40:30.000Z" itemprop="datePublished">2023-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/09/17/mysqlOptimize/">Mysql优化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、sql性能下降的原因"><a href="#一、sql性能下降的原因" class="headerlink" title="一、sql性能下降的原因"></a>一、sql性能下降的原因</h2><ul>
<li>外部原因<ol>
<li>计算机磁盘空间占用较大，服务器cpu性能及内存不足</li>
</ol>
</li>
<li>内部原因<ol>
<li>程序员编写的sql语句有问题</li>
<li>索引失效</li>
<li>表关联太多</li>
<li>服务器参数设置不合理</li>
</ol>
</li>
</ul>
<h2 id="二、Sql读取顺序"><a href="#二、Sql读取顺序" class="headerlink" title="二、Sql读取顺序"></a>二、Sql读取顺序</h2><ul>
<li><p><strong>代码编写的顺序</strong></p>
<blockquote>
<p>select-&gt;distinct-&gt;from-&gt;join-&gt;on-&gt;where-&gt;group by-&gt;having-&gt;order by-&gt;limit<br><br></p>
</blockquote>
</li>
<li><p><strong>Msql读取顺序</strong></p>
<blockquote>
<p>from-&gt;on-&gt;join-&gt;where-&gt;group by-&gt;having-&gt;select-&gt;distinct-&gt;order by-&gt;limit</p>
</blockquote>
</li>
<li><p><strong>整体过程</strong></p>
<ol>
<li>先对多表进行关联，根据条件找出符合的记录</li>
<li>在符合的记录基础上进行where条件过滤</li>
<li>对筛选出的记录进行分组操作</li>
<li>分组完成后再进行having操作，过滤出满足条件的数据</li>
<li>对取出的记录进行排序</li>
<li>在按照分页条件取出要显示的数据</li>
</ol>
</li>
</ul>
<h2 id="三、Mysql执行计划Explain"><a href="#三、Mysql执行计划Explain" class="headerlink" title="三、Mysql执行计划Explain"></a>三、Mysql执行计划Explain</h2><h3 id="1-命令简介"><a href="#1-命令简介" class="headerlink" title="1.命令简介"></a>1.命令简介</h3><p><strong>执行示例</strong></p>
<ul>
<li><blockquote>
<p>explain select * from his_care_history hch left join his_care_order hco on hco.patient_name &#x3D; hch.patient_name </p>
</blockquote>
<img src="/blog/2023/09/17/mysqlOptimize/explain.png" class title="explain">
<table>
<thead>
<tr>
<th>字段名</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>编号</td>
</tr>
<tr>
<td>select_type</td>
<td>查询类型</td>
</tr>
<tr>
<td>table</td>
<td>表名</td>
</tr>
<tr>
<td>partitions</td>
<td>分区</td>
</tr>
<tr>
<td>type</td>
<td>类型</td>
</tr>
<tr>
<td>possible_keys</td>
<td>可能用到的索引</td>
</tr>
<tr>
<td>key</td>
<td>实际使用的索引</td>
</tr>
<tr>
<td>key_len</td>
<td>实际使用的索引的长度</td>
</tr>
<tr>
<td>ref</td>
<td>表之间的引用</td>
</tr>
<tr>
<td>rows</td>
<td>扫描的行数</td>
</tr>
<tr>
<td>filtered</td>
<td>过滤</td>
</tr>
<tr>
<td>Extra</td>
<td>额外的信息</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="2-索引type详解"><a href="#2-索引type详解" class="headerlink" title="2.索引type详解"></a>2.索引type详解</h3><p>注：mysql默认存储引擎innodb只显式支持B-Tree( 从技术上来说是B+Tree)索引。</p>
<blockquote>
<p>性能 高—-&gt;低<br>system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL</p>
</blockquote>
<p><em>其中system、const只是理想类型，基本达不到</em><br><br><em>调优后实际能优化到ref&gt;range这两个类型，通俗来讲就是查询的条件要是索引</em></p>
<table>
<thead>
<tr>
<th>type类型</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>system</td>
<td>整张表只有一条数据</td>
</tr>
<tr>
<td>const</td>
<td>用于Primary key 或 unique索引且结果只有一条数据</td>
</tr>
<tr>
<td>eq_ref</td>
<td>使用索引且返回结果唯一非空</td>
</tr>
<tr>
<td>ref</td>
<td>使用索引对返回结果无要求</td>
</tr>
<tr>
<td>range</td>
<td>使用索引且使用范围查询（where &lt;&gt; in等）</td>
</tr>
<tr>
<td>index</td>
<td>查询被声明是索引的那一列</td>
</tr>
<tr>
<td>ALL</td>
<td>全表查询</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhaokunbokeyuan256/p/10761548.html">索引type详解</a></td>
<td></td>
</tr>
</tbody></table>
<h2 id="四、Sql及索引优化"><a href="#四、Sql及索引优化" class="headerlink" title="四、Sql及索引优化"></a>四、Sql及索引优化</h2><ol>
<li><p>排序字段加索引</p>
<blockquote>
<p>对查询进行优化，要尽量避免全表扫描，首先应考虑在where和order by涉及的列上建立索引</p>
</blockquote>
</li>
<li><p>where条件中or两边的字段没有索引时尽量少用or</p>
<blockquote>
<p>or两边的字段中如果有一个不是索引字段会造成查询不走索引</p>
</blockquote>
<ul>
<li>where条件后字段建立索引 type的值是const,查询效率高</li>
<li>where条件后字段没有建立索引 type的值为ALL,变成全表扫描</li>
</ul>
</li>
<li><p>区分in与exits</p>
<ul>
<li>in:当子查询的数量少的时候</li>
<li>exits:当外层查询的数据少，内层查询数据量大的时候</li>
</ul>
</li>
<li><p>不建议使用%前缀模糊查询</p>
<blockquote>
<p>“%name”或者LIKE”%name”,这种查询会导致索引失效而进行全表扫描<br>但是可以使用LIKE”name%”，type的值为range</p>
</blockquote>
</li>
<li><p>避免在where子句中对字段进行表达式操作</p>
</li>
<li><p>注意范围查询语句</p>
<blockquote>
<p>对于联合索引来说，如果存在范围查询，会造成后面的索引字段失效</p>
</blockquote>
</li>
<li><p>使用join优化</p>
</li>
</ol>
<ul>
<li>什么是驱动表？</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>A left join B</td>
<td>A为驱动表</td>
</tr>
<tr>
<td>B right join A</td>
<td>B为驱动表</td>
</tr>
<tr>
<td>A inner join</td>
<td>mysql自动找出数据少的表作为驱动表</td>
</tr>
</tbody></table>
<ul>
<li><p>合理利用索引</p>
<blockquote>
<p>被驱动表的索引字段作为on的限制字段</p>
</blockquote>
</li>
<li><p>利用小表驱动大表</p>
<blockquote>
<p>减少嵌套循环中的循环次数，以减少IO总量及CPU运算的次数</p>
</blockquote>
</li>
</ul>
<h2 id="五、系统参数调优"><a href="#五、系统参数调优" class="headerlink" title="五、系统参数调优"></a>五、系统参数调优</h2><h3 id="1-公共参数"><a href="#1-公共参数" class="headerlink" title="1.公共参数"></a>1.公共参数</h3><table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>max_connections &#x3D; 1000</td>
<td>同时处理最大连接数，推荐设置最大连接数是上线连接数的80%</td>
</tr>
<tr>
<td>sort_buffer_size &#x3D; 2M</td>
<td>查询排序时缓冲区大小，只对order by和group by起作用，可增大此值为16M</td>
</tr>
<tr>
<td>open_files_limit &#x3D; 10240</td>
<td>Mysql打开的文件描述符限制，默认最小1024</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunshucloud.github.io/blog/2023/09/17/mysqlOptimize/" data-id="clnyod4w900039xk6908yaos5" data-title="Mysql优化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-jvm-memory-model" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/09/07/jvm-memory-model/" class="article-date">
  <time class="dt-published" datetime="2023-09-07T15:38:28.000Z" itemprop="datePublished">2023-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/09/07/jvm-memory-model/">jvm调优</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="一、类加载机制"><a href="#一、类加载机制" class="headerlink" title="一、类加载机制"></a>一、类加载机制</h2><h3 id="1-类加载过程"><a href="#1-类加载过程" class="headerlink" title="1.类加载过程"></a>1.类加载过程</h3><img src="/blog/2023/09/07/jvm-memory-model/classloader.png" class title="类加载过程">
<h4 id="1-1-加载"><a href="#1-1-加载" class="headerlink" title="1.1 加载"></a>1.1 加载</h4><ul>
<li>获取类的全限定类名，把经由源文件编译后的class字节码文件转为二进制流</li>
<li>将二进制流中类的描述信息存入方法区，如创建时间，版本等，而非成员变量之类</li>
<li>提取二进制流中的信息，最终转为java.lang.Class对象并将其存入堆中</li>
</ul>
<h4 id="1-2链接"><a href="#1-2链接" class="headerlink" title="1.2链接"></a>1.2链接</h4><ul>
<li>验证：验证被加载类的正确性：如文件的格式，元数据等。<br></li>
<li>准备：在方法区中为静态变量分配空间，并设置初始值。<br></li>
<li>解析：把类符的号引用转为直接引用</li>
</ul>
<h4 id="1-3初始化"><a href="#1-3初始化" class="headerlink" title="1.3初始化"></a>1.3初始化</h4><ul>
<li>为类的静态变量设置默认值，执行静态代码</li>
</ul>
<h3 id="2-类加载器"><a href="#2-类加载器" class="headerlink" title="2.类加载器"></a>2.类加载器</h3><ul>
<li>类加载器实现类加载的过程<img src="/blog/2023/09/07/jvm-memory-model/delegate.png" class title="delegate"></li>
</ul>
<h4 id="2-1分类"><a href="#2-1分类" class="headerlink" title="2.1分类"></a>2.1分类</h4><ul>
<li>启动类加载器（Bootstrap classLoader）:主要负责加载JAVA中的一些核心类库，主要位于<JAVA_HOME>&#x2F;lib&#x2F;rt.jar中</JAVA_HOME></li>
<li>拓展类加载器（Extension classLoader）:主要加载类中的一些拓展类，位于<JAVA_HOME>&#x2F;lib&#x2F;ext中，是启动类加载器的子类</JAVA_HOME></li>
<li>应用类加载器（System classLoader）:主要用于加载CLASSPATH路径下我们自己写的类，是拓展类加载器的子类</li>
</ul>
<h4 id="2-2双亲委派模型"><a href="#2-2双亲委派模型" class="headerlink" title="2.2双亲委派模型"></a>2.2双亲委派模型</h4><ul>
<li>如果一个类加载器收到类加载请求，首先判断是否已经加载过了，若没有加载则将这个请求委派（delegate）给父类的加载器，依次递归，如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子类加载器才会尝试自己加载<br>默认类加载器的实现如下：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> Class&lt;?&gt; loadClass(String name, <span class="type">boolean</span> resolve) &#123;</span><br><span class="line">  <span class="comment">// First, check if this class loader has directly defined the class or if the</span></span><br><span class="line">  <span class="comment">// JVM has initiated the class load with this class loader.</span></span><br><span class="line">  Class&lt;?&gt; result = findLoadedClass(name);</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Next, delegate to the parent.</span></span><br><span class="line">      result = getParent().loadClass(name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">      <span class="comment">// Finally, search locally if the parent could not find the class.</span></span><br><span class="line">      result = findClass(ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// As a remnant of J2SE 1.0.2, link the class if a subclass of the class</span></span><br><span class="line">  <span class="comment">// loader class requested it (the JVM never calls the method,</span></span><br><span class="line">  <span class="comment">// loadClass(String) passes false, and the protected access modifier prevents</span></span><br><span class="line">  <span class="comment">// callers from passing true).</span></span><br><span class="line">  <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">    resolveClass(result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<p><strong>如何打破双亲委派机制</strong><br><br><em>自定义加载类继承ClassLoader类，重写loadClass方法</em></p>
<h2 id="二、JVM内存区域划分"><a href="#二、JVM内存区域划分" class="headerlink" title="二、JVM内存区域划分"></a>二、JVM内存区域划分</h2><ul>
<li>线程独享区<ul>
<li>程序计数器</li>
<li>虚拟机栈</li>
<li>本地方法区</li>
</ul>
</li>
<li>线程共享区<ul>
<li>堆内存</li>
<li>方法区</li>
</ul>
</li>
</ul>
<hr>
<p><strong>JVM进行内存分区的原因？</strong><br>    <br><em>提高垃圾回收效率</em></p>
<h2 id="三、JVM五大分区"><a href="#三、JVM五大分区" class="headerlink" title="三、JVM五大分区"></a>三、JVM五大分区</h2><h3 id="1-程序计数器"><a href="#1-程序计数器" class="headerlink" title="1.程序计数器"></a>1.程序计数器</h3><p>在多线程并行运行时，微观上仍然是串行运行的，只是在很小的时间片内进行线程的切换，此时记录每个线程的运行的位置就至关重要，程序计数器就实现这个功能。</p>
<h3 id="2-本地方法栈"><a href="#2-本地方法栈" class="headerlink" title="2.本地方法栈"></a>2.本地方法栈</h3><p>非java语言实现</p>
<h3 id="3-虚拟机栈"><a href="#3-虚拟机栈" class="headerlink" title="3.虚拟机栈"></a>3.虚拟机栈</h3><p>存放当前线程中所声明的变量，包括基本数据类型的数据和引用数据类型的引用（在堆中的地址）</p>
<h4 id="3-1栈帧"><a href="#3-1栈帧" class="headerlink" title="3.1栈帧"></a>3.1栈帧</h4><ul>
<li>一个线程中可能有多个方法，不同方法又可能有相同的变量名，为了区别，每一个方法都对应一个栈帧，栈帧中存放<ol>
<li>局部变量表（Local Variables）</li>
<li>操作数栈(Operand Stack)</li>
<li>动态链接（Dynamic Linking）– 常量数据的引用（例如 final int b&#x3D;10 的地址）</li>
<li>方法返回值（Return Address）– 方法正常退出或异常退出的定义</li>
</ol>
</li>
</ul>
<p><strong>为什么虚拟机栈要称为栈？</strong><br><br><em>一个线程中含有多个方法，当其中一个方法A调用另一个方法B时，就需要把主动调用的那个方法A压入栈中，利用栈的先进后出的原则，在被调用方法B结束后继续运行A方法。</em><br><br><br><strong>为什么a&#x3D;a+1效率要低于a++的效率？</strong><br><br>a++是直接在局部变量中操作的。a&#x3D;a+1需要先在局部变量中取到a的值,然后在操作数栈中操作。</p>
<h3 id="4-方法区"><a href="#4-方法区" class="headerlink" title="4.方法区"></a>4.方法区</h3><p>在java8之后，方法区又称为元空间（MetaSpace），方法区在逻辑上属于堆的一部分，但一些具体机制和堆有区别，如：一些JVM的方法是可以不进行垃圾回收的，关闭JVM时才会释放方法区的内存。所以方法区还有一个别名叫非堆，目的是和堆分开。<br>方法区会存储</p>
<ul>
<li>类信息–版本号、创建时间等(如果加载大量class文件，会造成方法区内存溢出，如一个tomcat运行20-30个项目)</li>
<li>静态变量</li>
<li>常量（JDK8之后不存放字符串常量 因为字符创常量容易早造成内存泄露）</li>
</ul>
<h3 id="5-堆内存"><a href="#5-堆内存" class="headerlink" title="5.堆内存**"></a>5.堆内存**</h3><p>java将对象存放在堆内存中，堆内存所需要的空间是比较大的。对于JVM调优主要是针对堆内存的调优，比如分配堆内存的空间。</p>
<h2 id="四、JVM执行引擎"><a href="#四、JVM执行引擎" class="headerlink" title="四、JVM执行引擎"></a>四、JVM执行引擎</h2><p>执行引擎是java虚拟机核心的组成部分之一。JVM将class字节码文件加载到内存，但字节码文件不能直接运行在操作系统上，为了执行内存中的字节码文件指令，执行引擎（Execution Engine）就要将字节码指令解释&#x2F;编译为对应平台上的本地机器指令。<br><br>执行引擎的翻译过程有两种：</p>
<ol>
<li>使用解释器</li>
<li>使用即时编译器</li>
</ol>
<h3 id="1-解释器与即时编译器"><a href="#1-解释器与即时编译器" class="headerlink" title="1.解释器与即时编译器"></a>1.解释器与即时编译器</h3><h4 id="解释器"><a href="#解释器" class="headerlink" title="解释器"></a>解释器</h4><p>把字节码看成脚本，根据字节码中的指令，由JVM去调用实际的本地方法。</p>
<h4 id="即时编译器"><a href="#即时编译器" class="headerlink" title="即时编译器"></a>即时编译器</h4><p>把执行过程中发现的热点位置，由jvm内部的即时编译器编译为本地机器码直接执行</p>
<h4 id="二者的区别"><a href="#二者的区别" class="headerlink" title="二者的区别"></a>二者的区别</h4><p>把源代码编译成和本地i机器平台相关的机器语言，即适用与本机的机器码，只能在本机上运行，叫即时编译。<br><br>编译成一种中间的字节码，与机器平台无关的，这个编译后的字节码可以在很多处理器上运行，叫解释型的</p>
<h3 id="五、堆内存模型"><a href="#五、堆内存模型" class="headerlink" title="五、堆内存模型"></a>五、堆内存模型</h3><h4 id="1-java对象内存布局"><a href="#1-java对象内存布局" class="headerlink" title="1.java对象内存布局"></a>1.java对象内存布局</h4><img src="/blog/2023/09/07/jvm-memory-model/javaobject.png" class title="java_object">
<ul>
<li><strong>对象头</strong><table>
<thead>
<tr>
<th align="center">name</th>
<th align="center">description</th>
</tr>
</thead>
<tbody><tr>
<td align="center">MarkWord</td>
<td align="center">一系列标记位（哈希码、分代年龄、锁状态标记等），在 64 位系统中占8 字节。</td>
</tr>
<tr>
<td align="center">ClassPoint</td>
<td align="center">对象对应的类信息的内存地址，在 64 位系统中占 8 字节。</td>
</tr>
<tr>
<td align="center">Length</td>
<td align="center">数组对象特有，表示数组长度，占 4字节</td>
</tr>
</tbody></table>
</li>
<li><strong>实例数据</strong>–包含了对象的所有成员变量，大小由变量类型决定。<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>1字节</td>
</tr>
<tr>
<td>boolean</td>
<td>1字节</td>
</tr>
<tr>
<td>short</td>
<td>2字节</td>
</tr>
<tr>
<td>char</td>
<td>2~3字节</td>
</tr>
<tr>
<td>int</td>
<td>4字节</td>
</tr>
<tr>
<td>float</td>
<td>4字节</td>
</tr>
<tr>
<td>long</td>
<td>8字节</td>
</tr>
<tr>
<td>double</td>
<td>8字节</td>
</tr>
<tr>
<td>引用数据类型</td>
<td>8字节</td>
</tr>
</tbody></table>
</li>
<li><strong>对齐填充</strong><br>将对象大小填充为 8 字节的整数倍</li>
</ul>
<h4 id="2-JVM内存溢出和垃圾回收机制"><a href="#2-JVM内存溢出和垃圾回收机制" class="headerlink" title="2.JVM内存溢出和垃圾回收机制"></a>2.JVM内存溢出和垃圾回收机制</h4><ol>
<li>垃圾回收的意义：避免出现内存溢出（Out Of Memory），简称OOM</li>
<li>堆内存分区的意义：<ul>
<li>提高搜索垃圾的效率</li>
<li>垃圾回收后可以更好的利用空间，存放大对象</li>
<li>尽可能减少GC（Garbage Collection）次数</li>
</ul>
</li>
</ol>
<h4 id="3-堆内存的划分"><a href="#3-堆内存的划分" class="headerlink" title="3.堆内存的划分"></a>3.堆内存的划分</h4><ul>
<li>老年代</li>
</ul>
<p>对象会优先分配到新生代内存中，每次 GC 后没有回收的对象年龄加 1，年龄到<br>15 还没有被回收，对象会存放到老年代内存中；如果对象较大，超过新生代内存的一<br>半，对象也会存放到老年代区域</p>
<ul>
<li>新生代<ul>
<li>Eden区</li>
<li>Suvivor区（两个）</li>
</ul>
</li>
</ul>
<p>为了**减少young区垃圾回收后的空间碎片(复制算法)**（非连续的地址空间不能存储大对象），新生代又分为Eden区和两个Survivor<br>区，且始终有一个 Suvivor 区保持闲置。对象会先存放到 Eden 区当中，Eden 区空间<br>满了之后会进行 young 区的垃圾回收，之后将 young 区所有存活的对象复制到闲置<br>的 Suvivor 区中，并清空 Eden 区和正在使用的 Survivor 区。</p>
<p><strong>垃圾回收前</strong></p>
<img src="/blog/2023/09/07/jvm-memory-model/heap1.jpg" class title="heap1"><br>
<p><strong>垃圾回收后</strong></p>
<img src="/blog/2023/09/07/jvm-memory-model/heap2.jpg" class title="heap2">

<h4 id="4-YoungGC-和-OldGC"><a href="#4-YoungGC-和-OldGC" class="headerlink" title="4.YoungGC 和 OldGC"></a>4.YoungGC 和 OldGC</h4><ul>
<li>YoungGC</li>
</ul>
<p>新生代区域的垃圾回收称之为 YoungGC，也叫 MinorGC，Eden 区满后会触发<br>YoungGC</p>
<ul>
<li>OldGC</li>
</ul>
<p>老年代区域的垃圾回收称之为 OldGC，也叫 MajorGC，OldGC 非常浪费性能，<br>所以我们的 JVM 调优要尽可能减少 OldGC 的次数， OldGC 往往伴随着 YoungGC。<br>YoungGC+OldGC &#x3D; FullG</p>
<h2 id="五、垃圾回收机制"><a href="#五、垃圾回收机制" class="headerlink" title="五、垃圾回收机制"></a>五、垃圾回收机制</h2><h3 id="1-堆内存模型设计是为了提高垃圾回收的效率，那么要如何判断一个对象是垃圾？"><a href="#1-堆内存模型设计是为了提高垃圾回收的效率，那么要如何判断一个对象是垃圾？" class="headerlink" title="1.堆内存模型设计是为了提高垃圾回收的效率，那么要如何判断一个对象是垃圾？"></a>1.堆内存模型设计是为了提高垃圾回收的效率，那么要如何判断一个对象是垃圾？</h3><ul>
<li><p>引用计数法(java中未使用，在python中使用)</p>
<p>如果要操作对象，必须通过引用来进行。如果一个对象没有任何引用与之关联，则说明该对象基本不太可能在其他地方被使用到。那么这个对象就成为可被回收的对象了。这种方式简单，效率高，但是它无法解决循环引用的问题。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">Object</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObject1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObject</span>();</span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObject2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObject</span>();</span><br><span class="line">        myObject1.ref = myObject2;</span><br><span class="line">        myObject2.ref = myObject1;</span><br><span class="line">        myObject1 = <span class="literal">null</span>;</span><br><span class="line">        myObject2 = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从上面的代码可以轻易地发现myObject1与myObject2互为引用。<br>如果采用引用计数法，myObject1和myObject2将不能被回收，因为他们的引用计数无法为零。</p>
</blockquote>
<ul>
<li><p>可达性分析(java中使用)</p>
<p>以一个GC root对象作为起点进行搜索，如果在GC Root和对象之间没有可达路径，则称该对象是不可达的，此类对象需要进行垃圾回收。</p>
<p><strong>GC Root对象（什么样的对象可以称为GC Root对象）：</strong></p>
<ul>
<li>栈帧中的本地变量表中引用的对象</li>
<li>方法区（Metaspace）中静态属性引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>本地方法栈中引用的对象</li>
</ul>
</li>
</ul>
<h3 id="2-垃圾回收算法"><a href="#2-垃圾回收算法" class="headerlink" title="2.垃圾回收算法"></a>2.垃圾回收算法</h3><ul>
<li><strong>标记-清除算法</strong>:效率低，有空间碎片。old区使用的算法<img src="/blog/2023/09/07/jvm-memory-model/col1.png" class title="unreferenced">
<img src="/blog/2023/09/07/jvm-memory-model/col2.png" class title="removed"></li>
<li><strong>复制算法</strong>：空间碎片少，但会浪费空间。存活对象少才会使用的算法。young区使用的算法<img src="/blog/2023/09/07/jvm-memory-model/col3.png" class title="copy"></li>
<li><strong>标记-整理算法</strong>：空间碎片少，效率低。Old区使用的算法。<img src="/blog/2023/09/07/jvm-memory-model/col4.png" class title="move">
<img src="/blog/2023/09/07/jvm-memory-model/col5.png" class title="move">
<img src="/blog/2023/09/07/jvm-memory-model/col6.png" class title="move"></li>
</ul>
<h3 id="3-垃圾收集器"><a href="#3-垃圾收集器" class="headerlink" title="3.垃圾收集器"></a>3.垃圾收集器</h3><blockquote>
<p>垃圾收集器是对垃圾回收算法的实现。<br>垃圾收集器的执行效率&#x3D;吞吐量&#x2F;停顿时间<br>吞吐量&#x3D;用户代码执行时间&#x2F;（用户代码执行时间+停顿时间）</p>
</blockquote>
<h3 id="4-垃圾收集器的类型"><a href="#4-垃圾收集器的类型" class="headerlink" title="4.垃圾收集器的类型"></a>4.垃圾收集器的类型</h3><ul>
<li><strong>串行收集器</strong></li>
</ul>
<p>只有一个垃圾回收线程，在垃圾回收时暂停用户代码线程，如Serial和Serial Old</p>
<img src="/blog/2023/09/07/jvm-memory-model/collector_syn.png" class title="collector_syn">

<ul>
<li><strong>并行收集器</strong></li>
</ul>
<p>吞吐量优先，多个垃圾收集器线程共同工作，尽快完成垃圾收集。如ParNew,Parallel,Scanvenge,Parallel Old收集器。</p>
<img src="/blog/2023/09/07/jvm-memory-model/collector_asyn.png" class title="collector_asyn">

<ul>
<li><strong>并发收集器(目前主流的收集器)</strong></li>
</ul>
<p>停顿时间优先，用户线程和垃圾回收线程一同工作，用户代码线程也会完全停止一小段时间，如CMS,G1收集器。</p>


<h3 id="5-CMS收集器"><a href="#5-CMS收集器" class="headerlink" title="5.CMS收集器"></a>5.CMS收集器</h3><ul>
<li>CMS(concurrent mark sweep,并发标记扫描)收集器是并发收集器，是基于标语–清理的算法进行垃圾回收，用于oldGC。<ul>
<li>优点：并发手机、低停顿</li>
<li>缺点：会产生大量的空间碎片，停顿时间虽然短但是不可控。</li>
</ul>
</li>
</ul>
<p>CMS的工作步骤：</p>
<ul>
<li>初始标记： 暂停所有的其他线程(STW)，并记录下gc roots直接能引用的对象，速度很快。</li>
<li>并发标记： 并发标记阶段就是从GC Roots的直接关联对象开始遍历整个对象图的过程， 这个过程耗时较长但是不需要停顿用户线程， 可以与垃圾收集线程一起并发运行。因为用户程序继续运行，可能会有导致已经标记过的对象状态发生改变。</li>
<li>重新标记： 重新标记阶段就是为了修正并发标记期间因为用户程序继续运行而导致标记产生变动的那一部分对象的标记记录，这个阶段的停顿时间一般会比初始标记阶段的时间稍长，远远比并发标记阶段时间短。</li>
<li>并发清理： 开启用户线程，同时GC线程开始对未标记的区域做清扫。这个阶段如果有新增对象不做任何处理.</li>
<li>并发重置：重置本次GC过程中的标记数据。</li>
</ul>
<h3 id="6-G1收集器"><a href="#6-G1收集器" class="headerlink" title="6.G1收集器"></a>6.G1收集器</h3><ul>
<li>G1(garbage first,垃圾优先)收集器是并发收集器，从JDK1.7开始支持，能进行OldGC和YoungGC.Old区采用标记整理算法，Young区采用复制算法。</li>
<li>G1收集器没有<strong>固定的</strong>Old,Young,Eden,Survivor区，而是将内存分为一个个大小相等的Region（格子，1Mb~32Mb）。每次垃圾回收后，Region的用途可以发生改变，提高了内存的灵活性和利用率。<img src="/blog/2023/09/07/jvm-memory-model/region.png" class title="region"></li>
<li>G1收集器可以根据开发者设置的参数，<strong>停顿时间的期望值</strong>，优先筛选回收存活的对象比较少，垃圾对象比较大的Region区域，可以把更多的空间释放出来。<img src="/blog/2023/09/07/jvm-memory-model/G1.png" class title="G1"></li>
</ul>
<h3 id="7-如何选择垃圾收集器"><a href="#7-如何选择垃圾收集器" class="headerlink" title="7.如何选择垃圾收集器"></a>7.如何选择垃圾收集器</h3><ul>
<li>优先让服务器自己选择</li>
<li>如果内存小于100M,使用串行收集器</li>
<li>如果服务器是单核，并且没有停顿时间要求，使用串行收集器</li>
<li>如果允许停顿时间超过1秒，选择并行收集器</li>
<li>如果停顿时间不能超过1秒，使用并发收集器</li>
</ul>
<h2 id="六、JVM参数设置"><a href="#六、JVM参数设置" class="headerlink" title="六、JVM参数设置"></a>六、JVM参数设置</h2><h3 id="1-JVM参数设置方式"><a href="#1-JVM参数设置方式" class="headerlink" title="1.JVM参数设置方式"></a>1.JVM参数设置方式</h3><ul>
<li><p>Intellij idea:在运行的VM Option中设置</p>
<img src="/blog/2023/09/07/jvm-memory-model/vmoption1.png" class title="vmoption1">
<img src="/blog/2023/09/07/jvm-memory-model/vmoption2.png" class title="vmoption2">
</li>
<li><p>tomcat：进入 Tomcat 的 bin 目录下，打开文件 catalina.bat&#x2F;catalina.sh，修改如下参数</p>
<blockquote>
<p>set “JAVA_OPTS&#x3D;参数”</p>
</blockquote>
</li>
</ul>
<h3 id="2-JVM参数类型"><a href="#2-JVM参数类型" class="headerlink" title="2.JVM参数类型"></a>2.JVM参数类型</h3><ol>
<li>标准参数：不随jdk版本变化而变化的参数，如：-version</li>
<li>-X参数：不能保证所有的JVM都支持，如：</li>
</ol>
<ul>
<li>-Xcomp:使用即时编译器执行字节码文件  <img src="/blog/2023/09/07/jvm-memory-model/comp.png" class title="comp"></li>
<li>-Xint:使用解释器执行字节码文件   <img src="/blog/2023/09/07/jvm-memory-model/int.png" class title="int"></li>
<li>-Xmixed:混合模式，先使用解释器，即时编译器编译好后执行机器指令   <img src="/blog/2023/09/07/jvm-memory-model/mixed.png" class title="mixed"></li>
</ul>
<ol start="3">
<li>-XX参数：不能保证所有的JVM都支持</li>
</ol>
<ul>
<li>Boolean类型参数<ul>
<li>-XX:+UseG1GC:使用G1收集器</li>
<li>-XX:-UseG1GC:不使用G1收集器</li>
</ul>
</li>
<li>Key-Value类型参数<ul>
<li>-XX:MaxTenuringThreshold&#x3D;15:对象年龄达到15就会进入老年代</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunshucloud.github.io/blog/2023/09/07/jvm-memory-model/" data-id="clnyod4w900029xk69gwkelm0" data-title="jvm调优" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2023/09/07/hello-world/" class="article-date">
  <time class="dt-published" datetime="2023-09-07T13:54:00.000Z" itemprop="datePublished">2023-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2023/09/07/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://yunshucloud.github.io/blog/2023/09/07/hello-world/" data-id="clnyod4wa00059xk6ft45avoo" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/10/">October 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2023/09/">September 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2023/10/20/IocContainer/">IocContainer</a>
          </li>
        
          <li>
            <a href="/blog/2023/10/18/hasCodeAndEquals/">hasCodeAndEquals</a>
          </li>
        
          <li>
            <a href="/blog/2023/09/22/rabbitmq/">rabbitmq</a>
          </li>
        
          <li>
            <a href="/blog/2023/09/17/mysqlOptimize/">Mysql优化</a>
          </li>
        
          <li>
            <a href="/blog/2023/09/07/jvm-memory-model/">jvm调优</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 WangZhixiong<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.6.4.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>